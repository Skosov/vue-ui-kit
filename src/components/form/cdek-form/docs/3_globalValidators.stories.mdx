import { Meta, Story } from '@storybook/addon-docs';

<Meta
  title="Form/CdekForm/GlobalValidators"
  parameters={{
    version: {
      major: '0',
      minor: '0',
      patch: '1',
      postfix: 'alpha',
      style: {
        background: 'rgba(228, 0, 41, 0.05)',
        color: '#e40029',
      },
    },
  }}
/>

# Глобальные валидаторы

> В стадии разработки

Планируется добавить поддержку передачи параметра `rules` в виде строки `<название>|<название>`,
где каждое название будет отвечать за валидатор.

На данный момент доступны следующие валидаторы:

- `alpha` - в поле можно ввести только буквы (смотрит на текущую локаль)
- `required` - поле обязательное
- `email` - проверка на валидный email
- `regex` - проверка по паттерну (смотри подробнее ниже)

Например, чтобы поле могло принимать только буквы, надо написать:

```js
<CdekFormControl name="firstName" rules="alpha" />
```

> Попробуйте ввести цифры в поле `firstName`

<Story id="form-cdekform--global-validator" />

А чтобы поле было обязательным и проверялось на email, надо написать:

```js
<CdekFormControl name="email" rules="required|email" />
```

> Начните вводить `email`

> Очистите поле

<Story id="form-cdekformcontrol--required-with-email" />

---

### Regex

Правило `regex` можно передать только в форме объекта.

```js
const rules = {
  regex: /^([0-9]+)$/,
}

...

<CdekFormControl :rules="rules">
```

> Попробуйте ввести НЕ цифры

<Story id="form-cdekformcontrol--regex" />

Если хочется использовать `regex` с другими глобальными валидаторами, нужно
добавить в объект `rules` ключ с названием валидатора со значением `true`.

```js
const rules = {
  required: true,
  regex: /^([0-9]+)$/,
};
```

> Попробуйте ввести значение и стереть

<Story id="form-cdekformcontrol--regex-with-required" />

---

### Переводы

Изначально валидаторы поставляются с сообщениями только на русском языке. Однако библиотека
предоставляет сервисные функции, чтобы добавить/изменить сообщения на других локалях.

Например, чтобы добавить перевод к валидатору `required` на английском нужно написать:

```js
import { formSettings } from '@cdek-ui-kit/vue';

formSettings.addMessages('required', {
  en: 'Required field',
});
```

Первый параметр - название валидатора, второй параметр - объект по типу:

```js
{
  <код локали>: string;
}
```

Таким же образом можно заменить сообщение на `ru` локали, просто передав сообщение на `ru`:

```js
formSettings.addMessages('required', {
  ru: 'Другое сообщение на русском',
});
```

В валидаторах есть дефолтная локаль, если требуется сообщение на `zh` локали, а такой нет, то покажется
сообщение дефолтной локали. По стандарту показывается `ru`.

Если необходимо сменить дефолтную локаль, то нужно:

```js
formSettings.changeDefaultLocale('en');
```

Для смены языка сообщений при смене текущего языка на странице, нужно:

```js
formSettings.changeLocale(<код локали>);
```

Если подключен **i18n**, можно использовать такую функцию:

```js
export const checkLocaleForForm = () => {
  const { locale } = useI18n();

  watch(locale, (newLocale) => {
    formSettings.changeLocale(newLocale);
  });
};
```

Эту функцию нужно вызвать при инициализации приложения на клиенте.

> Попробуйте нажать "Продолжить" с пустым значение `firstName`, а далее переключить язык

<Story id="form-cdekform--change-language" />

---

### Кастомное сообщение об ошибке

Есть возможность локально переопределить сообщение об ошибке (глобально это не будет распространяться).
При передаче глобальных валидаторов в виде объекта, можно передать не только `true`, но и строку,
которая и будет являться новым сообщением.

```js
const rules = {
  required: 'Я - кастомное сообщение об ошибке',
};
```

> Введите и уберите текст, чтобы увидеть кастомное сообщение

<Story id="form-cdekformcontrol--required-custom-message" />

Если же вам необходимо вычислить сообщение об ошибке или например получить перевод, то
вы можете передать не строку, а функцию.

```js
const rules = {
  required: () => '',
};
```

> Введите и уберите текст несколько раз, вы заметите что оно меняется

<Story id="form-cdekformcontrol--required-custom-message-function" />

Будьте внимательны с названиями кастомных валидаторов, они не должны совпадать с заданными
глобальными валидаторами.
